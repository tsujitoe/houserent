var fs = require('fs');
var system = require('system');

//load device spec
var messages = [];
var device_info = {
                    "deviceName" : "iphone6",
                    "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36",
                    "windowSize":{
                        "width": 1100,
                        "height": 1000
                    }
                  }

// output messages and exit
function render_message(){
    if (messages.length>0)
        console.log(JSON.stringify(messages));
    phantom.exit();
}

// add message into list
function add_message(mtype, message){
    var package = {};
    package[mtype] = message;
    messages.push(package);
}

//input arg
if (system.args.length !== 2){
    add_message("error", "Usage: phantomjs get_screenshot.js [url]");
    render_message();
}else{
    var url = system.args[1];
}

//phantomjs onError
phantom.onError = function(message, trace) {
    add_message("error", "Phantomjs error: " + message);
    render_message();
};

//phantomjs main
function process(){

    //create page
    var page = require('webpage').create();

    //useragent setting
    page.settings.userAgent = device_info.userAgent;
    page.viewportSize = { 
                            width: device_info.windowSize.width, 
                            height: device_info.windowSize.height 
                        };
    page.clipRect = { 
                        top: 0, 
                        left: 0, 
                        width: device_info.windowSize.width, 
                        height: device_info.windowSize.height 
                    };

    //handler
    page.settings.resourceTimeout = 60000;
    page.onResourceTimeout = function(request) {
        add_message("error", "ResourceTimeout (60s)");
        render_message();
    };
    page.onAlert = function(msg) {
        add_message("error", "Alert detected");
        render_message();
    };
    page.onError = function (msg, trace) {
        add_message("warning", "Page error: " + msg);
    };
    //open url
    page.open(url, function(status) {
        //wait 5s for page loading
        window.setTimeout(function () {
            page.render("591-screenshot.png");
            add_message("success", true);
            render_message();
        }, 5000);
    });
}
process();